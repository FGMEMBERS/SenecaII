<?xml version="1.0"?>
<!--
 This file is part of FlightGear, the free flight simulator
 http://www.flightgear.org/

 Copyright (C) 2009 Torsten Dreyer, Torsten (at) t3r _dot_ de

 This program is free software; you can redistribute it and/or
 modify it under the terms of the GNU General Public License as
 published by the Free Software Foundation; either version 2 of the
 License, or (at your option) any later version.

 This program is distributed in the hope that it will be useful, but
 WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 General Public License for more details.
-->
<!-- Altimatic IIIc Autopilot Configuration -->
<!-- Written by Torsten Dreyer to match the performance described in -->
<!-- CENTURY III AUTOPILOT FLIGHT SYSTEM - PILOT'S OPERATING HANDBOOK -->
<!-- Based heavily on work from Dave Perry, who implemented the first -->
<!-- working CENTURYIII autopilot for FlightGear -->
<!-- This file contains the controller logic -->
<PropertyList>

  <params include="CENTURYIII-IO.xml"/>

  <!-- hack to provide power and serviceable properties from 
       old electrical system -->
  <logic>
    <name>electrical Power</name>
    <debug>false</debug>
    <input>
      <greater-than>
        <property>systems/electrical/outputs/autopilot</property>
        <value type="double">10.0</value>
      </greater-than>
    </input>
    <output alias="../../params/power"/>
    <output alias="../../params/serviceable"/>
  </logic>

  <!-- Switch interconnection logic -->
  <flipflop>
    <type>RS</type>
    <name>RollSwitch</name>
    <set>
      <or>
        <property alias="../../../../params/controls/roll/on"/>
        <property alias="../../../../params/controls/hdg/on"/>
      </or>
    </set>
    <reset>
      <or>
        <not>
          <property alias="../../../../../params/serviceable"/>
          <property alias="../../../../../params/power"/>
        </not>
        <property alias="../../../../params/controls/roll/off"/>
        <property alias="../../../../params/controls/disconnect"/>
        <not-equals>
          <property alias="../../../../../params/controls/manual-trim"/>
          <value>0</value>
        </not-equals>
      </or>
    </reset>
    <output alias="../../params/controls/roll/state"/>
  </flipflop>

  <flipflop>
    <type>RS</type>
    <name>HdgSwitch</name>
    <set>
      <or>
        <property alias="../../../../params/controls/hdg/on"/>
      </or>
    </set>
    <reset>
      <or>
        <property alias="../../../../params/controls/hdg/off"/>
        <and>
          <property alias="../../../../../params/controls/hdg/state"/>
          <not>
            <property alias="../../../../../../params/controls/roll/state"/>
          </not>
        </and>
      </or>
    </reset>
    <output alias="../../params/controls/hdg/state"/>
  </flipflop>

  <flipflop>
    <type>RS</type>
    <name>PitchSwitch</name>
    <set>
      <and>
        <property alias="../../../../params/controls/roll/state"/>
        <or>
          <property alias="../../../../../params/controls/pitch/on"/>
          <property alias="../../../../../params/controls/alt/on"/>
        </or>
      </and>
    </set>
    <reset>
      <or>
        <property alias="../../../../params/controls/pitch/off"/>
        <and>
          <property alias="../../../../../params/controls/pitch/state"/>
          <not>
            <property alias="../../../../../../params/controls/roll/state"/>
          </not>
        </and>
      </or>
    </reset>
    <output alias="../../params/controls/pitch/state"/>
  </flipflop>

  <flipflop>
    <type>RS</type>
    <name>AltSwitch</name>
    <set>
      <or>
        <property alias="../../../../params/controls/alt/on"/>
      </or>
    </set>
    <reset>
      <or>
        <property alias="../../../../params/controls/alt/off"/>
        <and>
          <property alias="../../../../../params/controls/alt/state"/>
          <not>
            <property alias="../../../../../../params/controls/pitch/state"/>
          </not>
        </and>
      </or>
    </reset>
    <output alias="../../params/controls/alt/state"/>
  </flipflop>

  <!-- Glideslope coupler logic -->

  <pi-simple-controller>
    <name>ALT timer</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property alias="../../../../params/controls/alt/lock"/>
      </condition>
    </enable>
    <reference>1</reference>
    <output alias="../../params/controls/alt/lock-timer"/>
    <config>
      <Kp>0.0</Kp>
      <Ki>0.05</Ki>
      <min>0.0</min>
      <max>1.0</max>
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>LOC NORM timer</name>
    <debug>false</debug>
    <enable>
      <condition>
        <equals>
          <property alias="../../../../../params/controls/mode"/>
          <value alias="../../../../../params/const/mode-loc-norm"/>
        </equals>
      </condition>
    </enable>
    <reference>1</reference>
    <output alias="../../params/controls/mode-timer"/>
    <config>
      <Kp>0.0</Kp>
      <Ki>0.05</Ki>
      <min>0.0</min>
      <max>1.0</max>
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>below GS timer</name>
    <debug>false</debug>
    <enable>
      <condition>
        <greater-than>
          <property alias="../../../../../params/input/gs-deflection"/>
          <value>0.6</value>
        </greater-than>
      </condition>
    </enable>
    <reference>1</reference>
    <output alias="../../params/input/gs-deflection-timer"/>
    <config>
      <Kp>0.0</Kp>
      <Ki>0.05</Ki>
      <min>0.0</min>
      <max>1.0</max>
    </config>
  </pi-simple-controller>

  <logic>
    <name>Glideslope Coupler Armed</name>
    <debug>false</debug>
    <input>
      <!-- if mode is LOC NORM -->
      <equals> 
        <property alias="../../../../params/controls/mode"/>
        <value alias="../../../../params/const/mode-loc-norm"/>
      </equals>
      <greater-than-equals> <!-- and for a at least 20 seconds -->
        <property alias="../../../../params/controls/mode-timer"/>
        <value>1.0</value>
      </greater-than-equals>

      <!-- and altitude hold -->
      <property alias="../../../params/controls/alt/lock"/> 
      <greater-than-equals> <!-- and for at least 20 seconds -->
        <property alias="../../../../params/controls/alt/lock-timer"/>
        <value>1.0</value>
      </greater-than-equals>

      <!-- and glideslope deflection up (min 60%) -->
      <or>
        <greater-than>
          <property alias="../../../../../params/input/gs-deflection"/>
          <value>0.6</value>
        </greater-than>
        <greater-than-equals> <!-- and for at least 20 seconds -->
          <property alias="../../../../../params/input/gs-deflection-timer"/>
          <value>1.0</value>
        </greater-than-equals>
        <property alias="../../../../params/controls/gs-armed"/>
      </or>
    </input>

    <output alias="../../params/controls/gs-armed"/>
  </logic>

  <logic>
    <name>Glideslope Captured</name>
    <debug>false</debug>
    <input>
      <property alias="../../../params/controls/gs-armed"/>
      <or>
        <less-than>
          <property alias="../../../../../params/input/gs-deflection"/>
          <value>0.0</value>
        </less-than>
        <property alias="../../../../params/controls/gs-captured"/>
      </or>
    </input>
    <output alias="../../params/controls/gs-captured"/>
  </logic>

</PropertyList>
